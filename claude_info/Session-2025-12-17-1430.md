# Session: December 17, 2025 - 2:30 PM

## Kate's Energy
Afternoon session, focused on visualization improvements. Wants to tackle planet glyph collision detection.

## What We're Working On
- Revisiting chart wheel planet glyph collision detection + adjustment algorithms
- Problem: not moving things apart enough, not detecting all collisions
- Especially bad in bi-wheel or tri-wheel charts on inner rings

## Progress
- Found collision detection code in `src/stellium/visualization/layers.py:1817-1955`
- Key functions: `_calculate_adjusted_positions`, `_find_collision_groups`, `_spread_group`
- Also found `resolve_dial_collisions` in `dial/layers.py` (similar but for dial charts)

## Analysis of Current Algorithm Issues

### The Big Problem: Fixed 6° min_separation doesn't scale for radius!
- Current: `min_separation = 6.0` degrees - hardcoded, radius ignored
- On outer ring (r=350px): 6° arc = ~37px of physical space
- On inner ring (r=150px): 6° arc = ~16px of physical space
- If glyphs are ~30px wide, inner rings NEED more angular separation!

### Other Issues Found:
1. **Sequential grouping only** - compares planet[i] to planet[i-1], misses multi-step collisions
2. **No wrap-around detection** - doesn't check if first/last planets collide at 0°/360°
3. **No post-spread verification** - after spreading, doesn't re-check for new collisions
4. **base_radius passed but never used!** - the radius parameter is ignored

## Solution Implemented

Rewrote `_calculate_adjusted_positions` in `layers.py:1817-1999` with:

1. **Radius-aware min_separation calculation:**
   ```python
   circumference = 2 * pi * base_radius
   min_separation = (glyph_width_px * buffer_factor * 360) / circumference
   min_separation = max(4.0, min(15.0, min_separation))
   ```

2. **Iterative force-based spreading:**
   - Multiple passes until convergence (or max 50 iterations)
   - Each planet gets pushed by overlapping neighbors
   - Movement capped at 2° per iteration for stability

3. **Proper circular distance handling:**
   - New `_circular_distance()` and `_signed_circular_distance()` helpers
   - Correctly handles 0°/360° wrap-around

4. **Wrap-around collision detection:**
   - Treats sorted list as circular (last connects to first)
   - Determines correct push direction based on short vs long path

5. **Max displacement limit:**
   - Glyphs can't move more than 20° from true position
   - Preserves visual accuracy while avoiding overlap

## Test Results

- Small radius (100px) spreads planets 29.8°, large radius (350px) spreads only 13.4°
- Wrap-around collision at 358°/2° correctly spread to 354°/6°
- 8 planets in 4° cluster spread to 43.5° span with 6.2° min separation
- All 1817 tests pass

## Test Charts Generated
- /tmp/single_chart_test.svg
- /tmp/biwheel_test.svg
- /tmp/triwheel_test.svg

